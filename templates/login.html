{% extends "main.html" %}



{% block title %} Login page {% endblock%}

{% block header %}
{% block script %}
  <!-- BEGIN Pre-requisites -->


  <!--  Step 1: Include the below script in the head tag-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://apis.google.com/js/client:platform.js?onload=start" async defer></script>

  <!-- END Pre-requisites -->
{% endblock %}

  <!--Include Facebook meta tag to enable API request via HTTP -->
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

// end of header
{% endblock %}

{% block content %}
  <!--Form for create-profile here followed by  -->
  <h1>Sign In</h1>

  <p class="black-text blue-text"> Sign up or Login with one of the providers below</p>


  <!-- GOOGLE SIGN IN -->


  <div class="row">
    {% block script %}
     <script>
       function start() {
         gapi.load('auth2', function() {
           auth2 = gapi.auth2.init({
             client_id: '377693933630-mt7bk2ot1bp6j06773v3n295h12bevpk.apps.googleusercontent.com'
           });
         });
       }
     </script>

     {% endblock %}


     <!--  Step 2: In the <body> tag, add the below button and div -->

     <!--GOOGLE BUTTON -->
    <div class="col">
      <button id="signinButton" class ='grid-cell'>
        <a>

          <img src ="{{url_for('static', filename='Google_G_logo.svg')}}" aria-hidden="true" width="24" height="24" veiwBox="0 0 24 24">

          <span>Google</span>
        </a>
      </button>
    </div>


     <div id="result"></div>
     <!--  Step 3: Add the below script before the ending </body> tag -->
     {% block script %}
     <script>
       //jQuery
       $('#signinButton').click(function() {
         function signInCallback(authResult){
           if (authResult['code']){
             // If the object authResult contains a parameter called code,
             // Then we know that our one time code is present

             //Hide the sign-in button now that the user is authorized
             $('#signinButton').attr('style', 'display: none');
             $.ajax({
               type: 'POST',
               //Endpoint/Address
               url: '/gconnect?state={{STATE}}',
               // Always include an `X-Requested-With` header in every AJAX request,
               // to protect against CSRF attacks.
               headers: {
               'X-Requested-With': 'XMLHttpRequest'
               },
               contentType: 'application/octet-stream; charset=utf-8',
               success:function(result){
                 $('#result').html('Login Successful!</br>'+ result + '</br>Redirecting...')
                      setTimeout(function() {
                       window.location.href = "/";
                      }, 2000);
               },
               processData:false,
               data:authResult['code']
             });
           } else{
             // handle error
             console.log('There was an error: ' + authResult['error']);
             $('#result').html('Failed to make a server-side call. Check your configuration and console.');
           }
         }
         auth2.grantOfflineAccess().then(signInCallback);
       });
     </script>
     {% endblock %}


  <!--FACEBOOK SIGN IN -->
  {% block script %}
   <script>


       // The code for Facebook javascript SDK
     window.fbAsyncInit = function() {
       FB.init({
         appId      : '{566543414103215}',
         cookie     : true, // enable cookies to allow the server to access
                            // the session
         xfbml      : true, // parse social plugins on this page
         version    : '{v5.0}' // use version 5.0
       });
        FB.AppEvents.logPageView();

     };


     // This code calls the SDK asynchronously, so that the rest of
     // the page can load without it.
     (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));


     // This function sends the access Token to the server
     function sendTokenToServer() {
       // This function below retreives my short-lived accessToken.
       var access_token = FB.getAuthResponse()['accessToken']; // Retreives
       console.log(access_token)
       console.log('Welcome!  Fetching your information.... ');
       // Below here, I am showing how I can use the facebook SDK
       // to also make API calls.
       FB.api('/me', function(response) {
         console.log('Successful login for: ' + response.name);
         // Now I sent the access_token to the server via Ajax,
         // along with the state value.
        $.ajax({
         type: 'POST',
         url: '/fbconnect?state={{STATE}}',
         processData: false,
         data: access_token,
         contentType: 'application/octet-stream; charset=utf-8',
         success: function(result) {
           // Handle or verify the server response if necessary.
           if (result) {
             $('#result').html('Login Successful!</br>'+ result + '</br>Redirecting...')
            setTimeout(function() {
             window.location.href = "/catalog";
            }, 4000);

         } else {
           $('#result').html('Failed to make a server-side call. Check your configuration and console.');
            }
         }

     });
       });
     }
   </script>
   {% endblock %}

       <!--The JS SDK Login Button
       This code lets facebook SDK create facebook log in button.
       When login is clicked, the button also specifies the scope of
       authorization my app wants to request and also invoke this
       sendTokenToServer method-->

  <!--FACEBOOK BUTTON-->

    <div class="col">
      <button class="grid-cell">
        <a id="facebook_auth" class="btn btn-default ux-btn-set-item alternative-login-button" scope="public_profile, email", onlogin="sendTokenToServer;" href='javascript:sendTokenToServer()'>

          <img src ="{{url_for('static', filename='Facebook_F_logo.svg')}}" aria-hidden="true" width="24" height="24" veiwBox="0 0 24 24">

          <span>Facebook</span>
        </a>
      </button>
    </div>


   <!--END FACEBOOK SIGN IN -->
  </div>


{% endblock %}
